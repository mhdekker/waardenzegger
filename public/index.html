<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Waardenzegger 2.0</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <script type="text/javascript" src="/node_modules/circletype/dist/circletype.min.js"></script>
    <script type="text/javascript" src="/node_modules/jquery/dist/jquery.min.js"></script>

    <div class="container">

        <div class="circle">

            <!-- State 0 -->
            <div id="state0" class="state">
                <h1 class="isCentered">Ben je er nog?</h1>
                <div class="bottomButtonContainer isCentered bottomToCenter">
                    <button class="bottomButton" onclick="nextButtonPressed()"><p class="bottomButtonText">Ja</p></button>
                </div>
            </div>

            <!-- State 1 -->
            <div id="state1" class="state active">
                <h1 class="isCentered curved-text">Welkom bij de Waardenzegger. Laat je waarden spreken in Digitale Dilemma’s.</h1>
                <button id="startButton" class="isCentered isPulsingAndRotating" onclick="nextButtonPressed()"><img src="assets/images/start.png" width="200px" height="200px"></button>
            </div>

            <!-- State 2 -->
            <div id="state2" class="state">
                <h1 class="isCentered" >Leg jullie hand op de hand voor je. De Waardenzegging gaat nu beginnen!</h1>
                <img class="isCentered isPulsingAndRotating" src="assets/images/hand.png">
                <svg width="98%" height="98%" xmlns="http://www.w3.org/2000/svg" class="timer_circle isCentered">
                    <g>
                     <circle id="circle" class="circle_animation" r="48%" cy="50%" cx="50%" border-sizing="border-box"; stroke-width="20" stroke ='#ffffff' fill="none"/>
                    </g>
                </svg>
            </div>

            <!-- State 3 -->
            <div id="state3" class="state">
                <div class="theEyeContainer isCentered">
                    <img class="theEye isCentered" src="assets/images/oog.png"/>
                </div>
            </div>

            <!-- State 4 -->
            <div id="state4" class="state">
                <div class="dillemaKeuze isCentered">
                    <div class="rechteTitel">
                        <h2>Kies één stelling uit het dilemma</h2>
                    </div>
                    <div class="stellingTitel stellingTitel1"><p>Titel</p></div>
                    <button class="dillemaKeuze1" onclick="dillemaChosen(0)"><img class="stellingImage" src="assets/dilemmas/1.png"></button>
                    <div class="dillemaWoord"> 
                        <h6>OF</h6>
                    </div>
                    <div class="stellingTitel stellingTitel2"><p>Titel</p></div>
                    <button class="dillemaKeuze2" onclick="dillemaChosen(1)"><img class="stellingImage" src="assets/dilemmas/1.png"></button>
                </div>
            </div>

            <!-- State 5 -->
            <div id="state5" class="state">
                <h1 class="isCentered">Vertel de anderen waarom je hiervoor kiest</h1>
                <div class="dillemaKeuze-5 isCentered">
                    <div class="stellingTitel-5"><p>Titel</p></div>
                    <div class="dillemaKeuze1-5"><img class="stellingImage-5" src="assets/dilemmas/1.png"></div>
                </div>
                <div class="bottomButtonContainer isCentered">
                    <button onclick="nextButtonPressed()" class="bottomButton"><p class="bottomButtonText">Verder</p></button>
                </div>
            </div>

            <!-- State 6 -->
            <div id="state6" class="state">
                <h1 class="isCentered"> Zien jullie de schijf met al die waarden? Geef hier een flinke zwieper aan.</h1>
                <img class="waardenschijf isCentered" src="assets/images/waardenschijf.png">
            </div>

            <!-- State 7 -->
            <div id="state7" class="state">
                <h1 class="isCentered">Wacht tot de waardenschijf gestopt is met draaien. Bekijk welke waarde voor jou ligt.</h1>
                <img class="waardenschijf2 isCentered" src="assets/images/waardenschijf.png">
            </div>

            <!-- State 8 -->
            <div id="state8" class="state">
                <h1 class="isCentered">Is de waarde voor jou positief, negatief of zit het er niet in bij de gekozen stelling?</h1>
                <div class="centerOffsetAndRotation"> 
                    <div class="dillemaKeuze-5 heightOffSetThumbs">
                        <div class="stellingTitel-5"><p>Titel</p></div>
                        <div class="dillemaKeuze1-5"><img class="stellingImage-5" src="assets/dilemmas/1.png"></div>
                    </div>
                </div>
                <div class="dontRotatePlease isCentered">
                    <div class="thumbsButtonsContainer thumbsButton0">
                        <button class="thumbsButtonUp" onclick="toggleButtons(0, 'Up')"><img src="assets/images/up.png" /></button>
                        <button class="thumbsButtonNiet" onclick="toggleButtons(0, 'Niet')"><img src="assets/images/niet.png" /></button>
                        <button class="thumbsButtonDown" onclick="toggleButtons(0, 'Down')"><img src="assets/images/down.png" /></button>
                    </div>
                    <div class="thumbsButtonsContainer thumbsButton1">
                        <button class="thumbsButtonUp" onclick="toggleButtons(1, 'Up')"><img src="assets/images/up.png" /></button>
                        <button class="thumbsButtonNiet" onclick="toggleButtons(1, 'Niet')"><img src="assets/images/niet.png" /></button>
                        <button class="thumbsButtonDown" onclick="toggleButtons(1, 'Down')"><img src="assets/images/down.png" /></button>
                    </div>
                    <div class="thumbsButtonsContainer thumbsButton2">
                        <button class="thumbsButtonUp" onclick="toggleButtons(2, 'Up')"><img src="assets/images/up.png" /></button>
                        <button class="thumbsButtonNiet" onclick="toggleButtons(2, 'Niet')"><img src="assets/images/niet.png" /></button>
                        <button class="thumbsButtonDown" onclick="toggleButtons(2, 'Down')"><img src="assets/images/down.png" /></button>
                    </div>
                    <div class="thumbsButtonsContainer thumbsButton3">
                        <button class="thumbsButtonUp" onclick="toggleButtons(3, 'Up')"><img src="assets/images/up.png" /></button>
                        <button class="thumbsButtonNiet" onclick="toggleButtons(3, 'Niet')"><img src="assets/images/niet.png" /></button>
                        <button class="thumbsButtonDown" onclick="toggleButtons(3, 'Down')"><img src="assets/images/down.png" /></button>
                    </div>
                </div>
            </div>

            <!-- State 9 -->
            <div id="state9" class="state">
                <h1 class="isCentered">Kies de stelling die het beste past bij de waarde voor je?</h1>
                <button class="isCentered" onclick="nextButtonPressed()"> verder </button>
            </div>

            <!-- State 10 -->
            <div id="state10" class="state">
                <h1 class="isCentered" >Leg jullie handen weer op de handjes</h1>
                <img class="isCentered isPulsingAndRotating" src="assets/images/hand.png">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" class="timer_circle isCentered">
                    <g>
                     <circle id="circle" class="circle_animation" r="48%" cy="50%" cx="50%" border-sizing="border-box"; stroke-width="20" stroke ='#ffffff' fill="none"/>
                    </g>
                </svg>
            </div>

            <!-- State 11 -->
            <div id="state11" class="state">
                <div class="theEyeContainer isCentered">
                    <img class="theEye isCentered" src="assets/images/oog.png"/>
                </div>            
            </div>

            <!-- State 12 -->
            <div id="state12" class="state">
                <h1 class="isCentered"> Vertel de anderen kort waarom jij hiervoor koos</h1>
                <div class="dillemaKeuze-5 isCentered">
                    <div class="stellingTitel-5"><p>Ik moet bij elk evenement zeggen dat ik niet op de foto wil, terwijl de rest dat wel wil.</p></div>
                    <button class="dillemaKeuze1-5" onclick="dillemaChosen()"><img class="stellingImage-5" src="assets/dilemmas/1.png"></button>
                </div>
                <div class="bottomButtonContainer isCentered">
                    <button onclick="nextButtonPressed()" class="bottomButton"><p class="bottomButtonText">Verder</p></button>
                </div>
            </div>

            <!-- State 13 -->
            <div id="state13" class="state">
                <h1 class="isCentered">Tijd om de Waardenzegger te voeden. Welk digitaal dilemma hebben jullie zelf weleens meegemaakt?</h1>
                <textarea id="nieuweVoeding" class="use-keyboard-input" placeholder="Typ hier het dillema kort in"></textarea>
                <div class="bottomButtonContainer isCentered">
                    <button onclick="saveInputToFile()" class="bottomButton"><p class="bottomButtonText">Verder</p></button>
                </div>              
            </div>

            <!-- State 14 -->
            <div id="state14" class="state">
                <h1 class="isCentered">Bedankt! #De_Waardenzegger</h1>
                <img class="isCentered isPulsingAndRotating" src="assets/images/hand.png">
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script>
        const socket = io();
        let chosenOne;
        let dillemaNumber = [];
        let dillemasText = [];
        let activeSensors = [0,0,0,0];
        let thumbsPressed = [0,0,0,0];

        var beginState= {
            name: 'state1'
        };

        socket.on('chosenOne', (_chosenOne) => {
            chosenOne = _chosenOne;
            switch(_chosenOne) {
                case 0:
                    $( ".circle" ).css( "transform", "rotate(180deg)" );
                    $( ".dontRotatePlease" ).css( "transform", "rotate(-180deg)" );
                    console.log("Rotation set to: 0");

                    break;
                case 1:
                    $( ".circle" ).css( "transform", "rotate(90deg)" );
                    $( ".dontRotatePlease" ).css( "transform", "rotate(-90deg)" );
                    console.log("Rotation set to: 1");

                    break;
                case 2:
                    $( ".circle" ).css( "transform", "rotate(0deg)" );
                    $( ".dontRotatePlease" ).css( "transform", "rotate(0deg)" );
                    console.log("Rotation set to: 2");

                    break;
                case 3:
                    $( ".circle" ).css( "transform", "rotate(270deg)" );
                    $( ".dontRotatePlease" ).css( "transform", "rotate(-270deg)" );
                    console.log("Rotation set to: 3");

                    break;
                default: 
                $( ".circle" ).css( "transform", "rotate(0)" );
            }
        });

        socket.on('dillemas', (dillemas) => {
            // Update the UI based on newState
            dillemaNumber[0] = dillemas[0];
            dillemaNumber[1] = dillemas[1];
            
            $('.dillemaKeuze img').eq(0).attr('src', "/assets/dilemmas/" + dillemaNumber[0] + ".png");
            $('.dillemaKeuze img').eq(1).attr('src', "/assets/dilemmas/" + dillemaNumber[1] + ".png");
            console.log("img1 " + dillemaNumber[0]);
            console.log("img2 " + dillemaNumber[1]);
        });

        socket.on('dillemasText', (_dillemasText) => {
            dillemasText = _dillemasText;

            $('.dillemaKeuze p').eq(0).text(dillemasText[dillemaNumber[0]-1]);
            $('.dillemaKeuze p').eq(1).text(dillemasText[dillemaNumber[1]-1]);
            console.log("text1 " + dillemaNumber[0]-1);
            console.log("text2 " + dillemaNumber[1]-1);
        })

        socket.on('test', (test) => {
            // Update the UI based on newState
            console.log("test: " + test);
        });

        socket.on('stateUpdate', (newState) => {

            $('.state.active').fadeOut('5000', function() {
                //Update the UI based on the new stat
                updateUI(newState);

                if (newState.name == "state2" || newState.name == "state10") {
                    startCountdown();
                }

                if (newState.name == "state13") {
                    const textarea = document.querySelector(".use-keyboard-input");
                    if (textarea) {
                        textarea.focus();
                    }
                } else {
                    document.querySelector(".keyboard").classList.add("keyboard--hidden");
                }

                //Log the current state
                console.log(`Moved to state: ${newState.name}`);
            });
        });

        socket.on('activeSensors', (_activeSensors) => {
            activeSensors = _activeSensors;
            console.log(activeSensors)
            updateButtonVisibility(activeSensors);
        });

        function updateButtonVisibility(activeSensors) {
            for (let i = 0; i < activeSensors.length; i++) {
                // Only process elements with value 0
                if (activeSensors[i] === 0) {
                    // Construct the class name for the corresponding div
                    const divClassName = 'thumbsButton' + i;

                    // Find the div by its class name
                    const div = document.querySelector('.' + divClassName);
                    if (div) {
                        // Set the display property to none
                        div.style.display = 'none';
                        thumbsPressed[i] = 1;
                    }
                } else if (activeSensors[i] === 1) {
                    const divClassName = 'thumbsButton' + i;

                    // Find the div by its class name
                    const div = document.querySelector('.' + divClassName);
                    if (div) {
                        // Set the display property to none
                        div.style.display = 'block';
                        thumbsPressed[i] = 1;
                    }
                }
            }
        }

        // Function to update UI
        function updateUI(state) {
            // Hide all states
            document.querySelectorAll("h1").forEach(el => el.classList.remove('curved-text'));
            document.querySelectorAll('.state').forEach(el => el.classList.remove('active'));
            
            // Show the current state
            document.getElementById(state.name).classList.add('active');
            $("#" + state.name).find("h1").addClass('curved-text');

            var $curvedText = $(".curved-text");
            updateCurvedText($curvedText,500);

            $('.active').fadeIn('500');
        }

        function nextButtonPressed() {
            socket.emit('buttonPress');
        }

        function dillemaChosen(number) {
            $('.dillemaKeuze-5 img').each(function() {
                $(this).attr('src', "/assets/dilemmas/" + dillemaNumber[number] + ".png");
            });
            $('.dillemaKeuze-5 p').each(function() {
                $(this).text(dillemasText[dillemaNumber[number]-1]);
            });

            socket.emit('buttonPress');
        }

        function saveInputToFile() {
            const textareaValue = document.getElementById('nieuweVoeding').value;
            socket.emit('saveToFile', textareaValue);
            document.getElementById('nieuweVoeding').value = '';
            nextButtonPressed();
        }

        function updateCurvedText($curvedText, radius) {
            var w = $curvedText.width(),
                h = $curvedText.height();
            var text = $curvedText.text();
            var html = "";
            Array.from(text).forEach(function (letter) {
                html += `<span>${letter}</span>`;
            });
            $curvedText.html(html);
            var $letters = $curvedText.find("span");
            $letters.css({
                position: "absolute",
                height:`${radius}px`,
                //backgroundColor:"orange",
                transformOrigin:"bottom center"
            });
            
            var circleLength = 2 * Math.PI * radius;
            var angleRad = w/(2*radius);
            if (angleRad == 0) {
                angleRad = 2.8;
            };
            var angle = 2 * angleRad * 180/Math.PI/text.length;
            angle = 4;
            
            $letters.each(function(idx,el){
                $(el).css({
                    transform:`translate(-0.25em,${-radius}px) rotate(${idx * angle - text.length*angle/2}deg)`
                })
            });   
        }

        function startCountdown() {
            var time = 9;
            var initialOffset = 4059;
            var i = 0;

            var interval = setInterval(function() {
                if (i >= time) { 
                    clearInterval(interval);
                    i = 0;
                    $('.circle_animation').css('stroke-dashoffset', initialOffset);
                    return;
                }

                var border = initialOffset - ((i + 1) * (initialOffset / time));
                $('.circle_animation').css('stroke-dashoffset', border);

                i++;
            }, 1000);
        }

        function toggleButtons(set, buttonType) {
            // Select the container of the clicked button set
            console.log(set + " - " + buttonType);
            var container = document.querySelector('.thumbsButton' + set);

            // Hide other buttons based on the buttonType
            container.querySelectorAll('button').forEach(function(btn) {
                if (!btn.classList.contains('thumbsButton' + buttonType)) {
                    btn.style.display = 'none';
                }
            });
            thumbsPressed[set] = 1;
            console.log(thumbsPressed);

            if (thumbsPressed.every(value => value === 1)) {
                thumbsPressed = [0,0,0,0];
                nextButtonPressed();
            }
        }

        const Keyboard = {
            elements: {
                main: null,
                keysContainer: null,
                keys: []
            },

            eventHandlers: {
                oninput: null,
                onclose: null
            },

            properties: {
                value: "",
                capsLock: false
            },

            init() {
                // Create main elements
                this.elements.main = document.createElement("div");
                this.elements.keysContainer = document.createElement("div");

                // Setup main elements
                this.elements.main.classList.add("keyboard", "keyboard--hidden");
                this.elements.keysContainer.classList.add("keyboard__keys");
                this.elements.keysContainer.appendChild(this._createKeys());

                this.elements.keys = this.elements.keysContainer.querySelectorAll(".keyboard__key");

                // Add to DOM
                this.elements.main.appendChild(this.elements.keysContainer);
                // document.body.appendChild(this.elements.main);

                const circleDiv = document.querySelector('.circle');
                circleDiv.appendChild(this.elements.main);

                // Automatically use keyboard for elements with .use-keyboard-input
                document.querySelectorAll(".use-keyboard-input").forEach(element => {
                    element.addEventListener("focus", () => {
                        this.open(element.value, currentValue => {
                            element.value = currentValue;
                        });
                    });
                });
            },

            _createKeys() {
                const fragment = document.createDocumentFragment();
                const keyLayout = [
                    "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "backspace",
                    "q", "w", "e", "r", "t", "y", "u", "i", "o", "p",
                    "caps", "a", "s", "d", "f", "g", "h", "j", "k", "l", "enter",
                    "", "z", "x", "c", "v", "b", "n", "m", ",", ".", "?",
                    "space"
                ];

                // Creates HTML for an icon
                const createIconHTML = (icon_name) => {
                    return `<i class="material-icons">${icon_name}</i>`;
                };

                keyLayout.forEach(key => {
                    const keyElement = document.createElement("button");
                    const insertLineBreak = ["backspace", "p", "enter", "?"].indexOf(key) !== -1;

                    // Add attributes/classes
                    keyElement.setAttribute("type", "button");
                    keyElement.classList.add("keyboard__key");

                    switch (key) {
                        case "backspace":
                            keyElement.classList.add("keyboard__key--wide");
                            keyElement.innerHTML = createIconHTML("backspace");

                            keyElement.addEventListener("click", () => {
                                this.properties.value = this.properties.value.substring(0, this.properties.value.length - 1);
                                this._triggerEvent("oninput");
                            });

                            break;

                        case "caps":
                            keyElement.classList.add("keyboard__key--wide", "keyboard__key--activatable");
                            keyElement.innerHTML = createIconHTML("keyboard_capslock");

                            keyElement.addEventListener("click", () => {
                                this._toggleCapsLock();
                                keyElement.classList.toggle("keyboard__key--active", this.properties.capsLock);
                            });

                            break;

                        case "enter":
                            keyElement.classList.add("keyboard__key--wide");
                            keyElement.innerHTML = createIconHTML("keyboard_return");

                            break;

                        case "space":
                            keyElement.classList.add("keyboard__key--extra-wide");
                            keyElement.innerHTML = createIconHTML("space_bar");

                            keyElement.addEventListener("click", () => {
                                this.properties.value += " ";
                                this._triggerEvent("oninput");
                            });

                            break;

                        case "done":
                            keyElement.classList.add("keyboard__key--wide", "keyboard__key--dark");
                            keyElement.innerHTML = createIconHTML("check_circle");
                            break;

                        default:
                            keyElement.textContent = key.toLowerCase();

                            keyElement.addEventListener("click", () => {
                                this.properties.value += this.properties.capsLock ? key.toUpperCase() : key.toLowerCase();
                                this._triggerEvent("oninput");
                            });

                            break;
                    }

                    fragment.appendChild(keyElement);

                    if (insertLineBreak) {
                        fragment.appendChild(document.createElement("br"));
                    }
                });

                return fragment;
            },

            _triggerEvent(handlerName) {
                if (typeof this.eventHandlers[handlerName] == "function") {
                    this.eventHandlers[handlerName](this.properties.value);
                }
            },

            _toggleCapsLock() {
                this.properties.capsLock = !this.properties.capsLock;

                for (const key of this.elements.keys) {
                    if (key.childElementCount === 0) {
                        key.textContent = this.properties.capsLock ? key.textContent.toUpperCase() : key.textContent.toLowerCase();
                    }
                }
            },

            open(initialValue, oninput, onclose) {
                this.properties.value = initialValue || "";
                this.eventHandlers.oninput = oninput;
                this.eventHandlers.onclose = onclose;
                this.elements.main.classList.remove("keyboard--hidden");
            },

            close() {
                this.properties.value = "";
                this.eventHandlers.oninput = oninput;
                this.eventHandlers.onclose = onclose;
                //this.elements.main.classList.add("keyboard--hidden");
            }
        };

        window.addEventListener("DOMContentLoaded", function () {
            Keyboard.init();

            console.log("Hey baby!");
        });
        </script>
</body>
</html>